BootStrap: docker
From: nvidia/cuda:12.4.1-cudnn-devel-ubuntu22.04

%post
  # Fix WARNING related to localtime
  touch /etc/localtime

  # Install required packages (verbose list)
  apt update && apt upgrade -y
  apt install -y \
    build-essential libgfortran5 libquadmath0 cmake git curl wget aria2 zip unzip
  
  # Add the en_US.UTF-8 locale (not needed if running only on WSL2)
  apt install -y locales
  locale-gen en_US.UTF-8
  
  # Clean up apt caches and unused packages
  rm -rf /var/lib/apt/lists/* && apt autoremove -y && apt clean

  # Install Pyenv in /usr/local/apps
  git clone https://github.com/pyenv/pyenv.git /usr/local/apps/pyenv
  export PYENV_ROOT="/usr/local/apps/pyenv"
  export PATH="${PYENV_ROOT}/bin:${PATH}"

  # Install Miniforge via Pyenv and add Miniforge to PATH
  pyenv install --list
  pyenv install miniforge3-24.11.3-2
  pyenv global miniforge3-24.11.3-2
  pyenv versions
  export MINIFORGE3_ROOT="${PYENV_ROOT}/versions/miniforge3-24.11.3-2"
  export PATH="${MINIFORGE3_ROOT}/bin:${PATH}"
  
  # Update conda itself
  conda update -n base conda
  # Create conda environment named bindcraft-conda
  conda create -n bindcraft-conda python=3.10
  # Install libraries required for BindCraft
  conda install \
    -n bindcraft-conda \
    -c conda-forge --channel https://conda.graylab.jhu.edu \
    pip pandas matplotlib numpy"<2.0.0" biopython scipy pdbfixer seaborn \
    libgfortran5 tqdm jupyter ffmpeg pyrosetta fsspec py3dmol \
    dm-tree joblib ml-collections immutabledict
  
  # Clean up conda caches
  conda clean --all --force-pkgs-dirs --yes
  # Activate bindcraft-conda environment
  export BINDCRAFT_CONDA="${MINIFORGE3_ROOT}/envs/bindcraft-conda"
  export PATH="${BINDCRAFT_CONDA}/bin:${PATH}"
  
  # Update pip itself
  python3 -m pip install --no-cache-dir --upgrade pip
  # Install JAX
  python3 -m pip install --no-cache-dir \
    "jax[cuda12]" chex dm-haiku "flax<0.10.0" optax
  # Install ColabDesign
  python3 -m pip install --no-cache-dir --no-deps \
    git+https://github.com/sokrypton/ColabDesign.git
  
  # Clone BindCraft
  git clone https://github.com/martinpacesa/BindCraft.git /usr/local/apps/BindCraft
  # Download AlphaFold 2 weights
  cd /usr/local/apps/BindCraft
  mkdir -p ./params && cd ./params
  curl -L -O 'https://storage.googleapis.com/alphafold/alphafold_params_2022-12-06.tar'
  tar --no-same-owner --no-same-permissions -xvf ./alphafold_params_2022-12-06.tar
  rm -f ./alphafold_params_2022-12-06.tar
  # Set executable permissions
  cd /usr/local/apps/BindCraft
  chmod +x ./functions/dssp
  chmod +x ./functions/DAlphaBall.gcc

  # Check the source channels of packages installed in bindcraft-conda environment
  conda list -n bindcraft-conda

%environment
  # Environment setup for BindCraft
  export MINIFORGE3_ROOT="/usr/local/apps/pyenv/versions/miniforge3-24.11.3-2"
  export BINDCRAFT_CONDA="${MINIFORGE3_ROOT}/envs/bindcraft-conda"
  export PATH="${BINDCRAFT_CONDA}/bin:${PATH}"
  export BINDCRAFT_HOME="/usr/local/apps/BindCraft"
  export PYTHONPATH="${BINDCRAFT_HOME}:${PYTHONPATH}"

%runscript
  # Define the script to run when the container starts
  # "$@" passes through any additional arguments to the command
  exec "$@"
